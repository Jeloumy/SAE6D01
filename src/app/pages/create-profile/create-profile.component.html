<div class="flex flex-col items-center gap-4 m-4 align-middle">
  <form (ngSubmit)="createProfile()" #profileForm="ngForm"
    class="w-full max-w-screen-md p-4 rounded-md sm:w-2/3 form-control bg-slate-100 dark:bg-slate-700"
    aria-label="Formulaire de création de profil">

    <div class="mt-2">
      <label class="label" for="username">
        <span class="font-bold label-text">Nom d'utilisateur</span>
      </label>
      <input type="text" [(ngModel)]="profile.username" name="username" id="username" placeholder="Nom d'utilisateur"
        required class="w-full input input-bordered" #username="ngModel" aria-required="true">
      <div *ngIf="username.invalid && (username.dirty || username.touched)" class="text-red-500">
        Le nom d'utilisateur est requis.
      </div>
    </div>

    <div class="mt-2" aria-label="Sélecteur de handicap">
      <app-handicap-selector [(selectedHandicaps)]="profile.handicapList"
        [(selectedDispositifLieu)]="profile.dispositifLieu"
        (selectedDispositifLieuChange)="profile.dispositifLieu = $event"></app-handicap-selector>
      <div *ngIf="profile.handicapList.length === 0 && (username.dirty || username.touched)" class="text-red-500">
        Au moins un type d'handicap est requis.
      </div>
    </div>

    <!-- Photo de Profil -->
    <label class="label">
      <span class="label-text text-neutral">Sélectionner une photo de profil</span>
    </label>
    <div class="flex items-center relative">
      <label for="fileInput" class="relative cursor-pointer">
        <input type="file" id="fileInput" (change)="onFileChange($event)" class="hidden">
        <div class="ml-4 avatar" *ngIf="photoPreview">
          <div class="w-24 rounded-full">
            <img [src]="photoPreview" alt="Aperçu de la photo de profil" title="Cliquez pour afficher la photo">
          </div>
        </div>
        <div class="ml-4 avatar placeholder" *ngIf="!photoPreview">
          <div class="w-24 rounded-full bg-neutral text-neutral-content">
            <span class="text-3xl">{{ profile.username | slice:0:2 }}</span>
          </div>
        </div>
        <div class="absolute bottom-0 right-0 p-1 bg-white rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M6.385 19.616q-.587 0-1.168-.204q-.58-.204-1.025-.566q.496-.327.844-.878t.349-1.352q0-.847.577-1.424q.577-.576 1.423-.576t1.423.576t.577 1.424q0 1.246-.877 2.123t-2.123.877M11.25 14.5l-1.711-1.711l8.18-8.181q.275-.275.688-.288t.712.288l.312.311q.3.3.3.7t-.3.7z"/></svg>
        </div>
      </label>
    </div>

    <div class="mt-2" aria-label="Préférences système">
      <label class="mt-4 label">
        <span class="font-bold label-text">Préférences système</span>
      </label>
    </div>
    <app-system-preferences [(preferences)]="systemPreferences"
      (preferencesChange)="updateSystemPreferences($event)"></app-system-preferences>

    <button class="w-full mt-4 btn btn-primary sm:w-auto" type="submit" [disabled]="profileForm.invalid">Créer</button>
  </form>

  <div class="w-full max-w-screen-md p-4 rounded-md sm:w-2/3 bg-slate-100 dark:bg-slate-700"
    aria-label="Liste des profils">
    <div *ngIf="profiles.length > 0; else noProfiles">
      <table class="table w-full">
        <thead>
          <tr>
            <th>Profil</th>
            <th>Handicaps</th>
            <th>Dispositifs</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let profile of profiles; let i = index"
            [ngClass]="{'text-blue-500': profile.username === currentProfile?.username}"
            (click)="selectProfile(profile, true)">
            <td class="flex flex-col items-center justify-center">
              <div *ngIf="profile.photo" class="avatar">
                <div class="w-16">
                  <img class="rounded-full" [src]="profile.photo" alt="Photo de profil">
                </div>
              </div>
              <div *ngIf="!profile.photo" class="avatar placeholder">
                <div class="w-16 rounded-full bg-neutral text-neutral-content">
                  <span class="text-3xl">{{ profile.username | slice:0:2 }}</span>
                </div>
              </div>
              <p class="mt-2 text-center"><b>{{ profile.username }}</b></p>
            </td>
            <td>
              <ul>
                <li *ngFor="let handicap of profile.handicapList" class="mb-2">{{ handicap.handicap }}</li>
              </ul>
            </td>
            <td>
              <ul>
                <li *ngFor="let dispositif of profile.dispositifLieu" class="mb-2">{{ dispositif.name }}</li>
              </ul>
            </td>
            <td>
              <div class="flex flex-col items-center gap-2 sm:gap-4">
                <button class="btn btn-primary btn-square" (click)="editProfile(profile); $event.stopPropagation();"
                  aria-label="Modifier le profil">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-error btn-square" (click)="deleteProfile(profile.id); $event.stopPropagation();"
                  aria-label="Supprimer le profil">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noProfiles>
      <div *ngIf="currentProfile === null" class="alert alert-warning">
        <span *ngIf="profiles.length === 0">
          <b>Aucun profil disponible.</b> <br> Veuillez créer un nouveau profil.
        </span>
        <span *ngIf="profiles.length > 0">
          Veuillez sélectionner un profil parmi les profils existants.
        </span>
      </div>
    </ng-template>
  </div>

  <div *ngIf="showModal" aria-label="Sélectionneur de profil">
    <app-profile-selector-dialog [profilesList]="profiles" (selectionConfirmed)="onProfileSelected($event)">
    </app-profile-selector-dialog>
  </div>
</div>